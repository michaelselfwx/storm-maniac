<!DOCTYPE html>
<html lang="en">
<head>
    <title>Interactive SPC/LSR Map | Storm Maniac</title>
    <link rel="icon" type="image/x-icon" href="stormmaniac_favicon.png">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="" />

    <!-- CSS for the page and the map -->
    <style>
        html,
        body,
        #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%; 
            width: 100%;
        }
        #dateDiv1 {
            position: absolute;
            top: 1%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 1);
            border: 1px solid black;
            border-radius: 5px;
            z-index: 1000;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: calc(0.5px + 1vw);
            padding: 1%; 
        }
        .small-legend {
            position: absolute;
            bottom: 0;
            left: 0;
            transform-origin: bottom left;
            transform: scale(0.8);
        }
        .small-legend .esri-legend__layer-caption {
                display: none;
        }
        .esri-layer-list {
            top: 0;
            right: 0;
            transform-origin: top right;
            transform: scale(1);
        }
        .editor-widget {
            position: absolute;
            bottom: 0;
            right: 0;
        }
        /* For mobile devices */
        @media screen and (max-width: 768px) {
            #dateDiv1 {
                width: 80%; 
                height: 4%; 
                font-size: calc(1px + 2.75vw); 
            }
            .small-legend {
                transform: scale(0.45);
                margin-bottom: 400px;
                }
            .esri-layer-list {
                transform: scale(0.45);
                margin-top: 30px;
            }
        }
        /* For iPads */
        @media screen and (min-width: 769px) and (max-width: 1024px) {
            #dateDiv1 {
                width: 55%; 
                height: 3%; 
                font-size: calc(1px + 2vw); 
            }
            .esri-layer-list {
                transform: scale(1);
                margin-top: 35px;
            }
        }
    </style>

    <!-- ArcGIS API's CSS file and JS library -->
    <script src="https://unpkg.com/@turf/turf@^7/turf.min.js"></script>
    <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.25/"></script>
</head>
<body>

    <!-- The div to display the map -->
    <div id="viewDiv"></div>
    <div id="dateDiv1"></div>

    <!-- JavaScript for the map -->
    <script>
        require([
            "esri/config",
            "esri/Map",
            "esri/views/MapView",
            "esri/layers/GeoJSONLayer",
            "esri/widgets/Legend",
            "esri/widgets/LayerList",
            "esri/widgets/Editor",
            "esri/Graphic",
            "esri/layers/FeatureLayer",
            "esri/widgets/Expand"
        ], function (esriConfig, Map, MapView, GeoJSONLayer, Legend, LayerList, Editor, Graphic, FeatureLayer, Expand) {
            // Set the API key
            esriConfig.apiKey = "AAPKfb3b968ef66d4c848e795b3dd01897e8uTic-7qcXbjlpUVMGReQlWKWAjnWq5pH5r7mLxpcFbX1tfR5Y4bLBPhLOwFOm7NL";
            
            // Make sure the page refreshes when the user is inactive
            var timeout;
            var delay = 5 * 60 * 1000; // 5 minutes
            function resetTimeout() {
                clearTimeout(timeout);
                timeout = setTimeout(function() {
                    location.reload();
                }, delay);
            }
            window.onload = resetTimeout;
            window.onmousemove = resetTimeout;
            window.onmousedown = resetTimeout; 
            window.ontouchstart = resetTimeout;
            window.onclick = resetTimeout;     
            window.onscroll = resetTimeout;    
            window.onkeypress = resetTimeout;


            // Create the map
            var map = new Map({
                basemap: "streets-navigation-vector",          
            });

            
            // Create the view
            var view = new MapView({
                container: "viewDiv",
                map: map,
                center: [-98.5795, 37.8283],
                ui: {
                    components: ["attribution"]
                }
            });
            view.scale = 18500000; // Sets a 1:24,0000 scale on the view

            // Add LayerList to the view
            var layerList = new LayerList({
                view: view
            });

            // Define geojsonLayers globally
            var geojsonLayer;
            var geojsonLayer2;
            var geojsonLayer3;
            var stormreportsJson;
            var userStormReports;


            // Define a function to get the URL for a given hour and date
            function getUrl(hour, date) {
                var minutes = Math.round((hour % 1) * 60);
                hour = ('0' + Math.floor(hour)).slice(-2);
                minutes = ('0' + minutes).slice(-2);

                var month = ('0' + date.month).slice(-2);  // Ensure 2 digits for month
                var day = ('0' + date.day).slice(-2);      // Ensure 2 digits for day

                var formattedDateTime = date.year + date.month + date.day + '_' + hour + minutes;
                var url = "https://apartment-optiplex.tail37d1f9.ts.net/proxy?url=https://www.spc.noaa.gov/products/outlook/archive/" + date.year + "/day1otlk_" + formattedDateTime + "_cat.lyr.geojson";
                return { url: url, formattedDateTime: formattedDateTime}
            }

            // Define a function to get the previous available hour
            function getPreviousHour(hour, date) {
                var index = availableHours.indexOf(hour);
                if (index > 0) {
                    return { hour: availableHours[index - 1], date: date };
                } else if (index === 0 || index === -1) {
                    date.setDate(date.getDate() - 1);
                    var year = date.getUTCFullYear();
                    var month = ('0' + (date.getUTCMonth() + 1)).slice(-2);
                    var day = ('0' + date.getUTCDate()).slice(-2);
                    return { hour: availableHours[availableHours.length - 1], date: { year: year, month: month, day: day } };
                }
            }

            // Define the updateDateDiv function
            function updateDateDiv1(layer) {
                    console.log(urlData.url);
                    fetch(urlData.url)
                        .then(function(response) {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(function(data) {
                            // Check if the data has features and the first feature has VALID and EXPIRE properties
                            if (data.features && data.features[0] && data.features[0].properties && data.features[0].properties.VALID && data.features[0].properties.EXPIRE) {
                                // Update the date div
                                var validTime = data.features[0].properties.VALID;
                                var expireTime = data.features[0].properties.EXPIRE;

                                var validFormatted = validTime.substring(4,6) + "/" + validTime.substring(6,8) + "/" + validTime.substring(0,4) + " " + validTime.substring(8,10) + validTime.substring(10,12) + "z";
                                var expireFormatted = expireTime.substring(4,6) + "/" + expireTime.substring(6,8) + "/" + expireTime.substring(0,4) + " " + expireTime.substring(8,10) + expireTime.substring(10,12) + "z";

                                var dateDiv1 = document.getElementById('dateDiv1');
                                dateDiv1.textContent = 'Day 1 Convective Outlook Valid: ' + validFormatted + ' - ' + expireFormatted;
                            } else {
                                console.error('Data does not have VALID and EXPIRE properties:', data);
                            }
                        })
                        .catch(function(error) {
                            console.error('Error fetching data:', error);
                        });
                }


            // Define a function to create a GeoJSON layer
            function createGeoJSONLayer(url, data) {
                // Remove any existing "Day 1 Convective Outlook" layer
                var existingLayer = map.findLayerById("Day1ConvectiveOutlook");
                if (existingLayer) {
                    map.remove(existingLayer);
                }

                // Define the severity order
                var severityOrder = ["High Risk", "Moderate Risk", "Enhanced Risk", "Slight Risk", "Marginal Risk", "General Thunderstorms Risk"];

                // Sort the features by severity
                data.features.sort((a, b) => severityOrder.indexOf(a.properties.LABEL2) - severityOrder.indexOf(b.properties.LABEL2));

                // Clip the polygons
                for (let i = 0; i < data.features.length; i++) {
                    for (let j = i + 1; j < data.features.length; j++) {
                        console.log(data.features);
                        console.log(data.features[i]);
                        console.log(data.features[j]);
                        if (data.features[i] && data.features[j]) {
                            try {
                                // Ensure both features are valid polygons
                                if (data.features[i].geometry.type === "Polygon" && data.features[j].geometry.type === "Polygon") {
                                    console.log(`Clipping feature ${j} with feature ${i}`);
                                    let difference = turf.difference(data.features[j], data.features[i]);
                                    if (difference) {
                                        data.features[j] = difference;
                                    } else {
                                        console.warn(`No difference found for feature ${j} with feature ${i}`);
                                    }
                                }
                            } catch (error) {
                                console.error('Error performing turf.difference:', error);
                            }
                        }
                    }
                }


                var renderer = {
                    type: "unique-value",
                    field: "LABEL2",
                    uniqueValueInfos: [
                        { 
                            "value": "General Thunderstorms Risk", 
                            "symbol": {
                                "type": "simple-fill", 
                                "color": [119, 186, 119, 0.35], 
                                "outline": { "width": 0.5, "color": "black" }
                            }
                        },
                        { 
                            "value": "Marginal Risk", 
                            "symbol": {
                                "type": "simple-fill", 
                                "color": [77, 255, 77, 0.3], 
                                "outline": { "width": 0.5, "color": "black" }
                            }
                        },
                        { 
                            "value": "Slight Risk", 
                            "symbol": {
                                "type": "simple-fill", 
                                "color": [255, 255, 0, 0.3], 
                                "outline": { "width": 0.5, "color": "black" }
                            }
                        },
                        { 
                            "value": "Enhanced Risk", 
                            "symbol": {
                                "type": "simple-fill", 
                                "color": [255, 153, 0, 0.35], 
                                "outline": { "width": 0.5, "color": "black" }
                            }
                        },
                        { 
                            "value": "Moderate Risk", 
                            "symbol": {
                                "type": "simple-fill", 
                                "color": [255, 0, 0, 0.7], 
                                "outline": { "width": 0.5, "color": "black" }
                            }
                        },
                        { 
                            "value": "High Risk", 
                            "symbol": {
                                "type": "simple-fill", 
                                "color": [199, 0, 199, 0.45], 
                                "outline": { "width": 0.5, "color": "black" }
                            }
                        }
                    ]
                };

                geojsonLayer = new GeoJSONLayer({
                    url: url.url,
                    title: "Day 1 Convective Outlook",
                    id: "Day1ConvectiveOutlook", // Set the ID of the layer
                    visible: true,
                    renderer: renderer,
                    popupTemplate: {
                        title: "Day 1 Categorical Outlook",
                        content: "{LABEL2}"
                    }
                });

                // Add the GeoJSON layer to the map
                map.add(geojsonLayer, 4);

                // // Update the date div
                // if (data) {
                //     var validTime = data.features[0].properties.VALID;
                //     var expireTime = data.features[0].properties.EXPIRE;

                //     var validFormatted = validTime.substring(4,6) + "/" + validTime.substring(6,8) + "/" + validTime.substring(0,4) + " " + validTime.substring(8,10) + validTime.substring(10,12) + "z";
                //     var expireFormatted = expireTime.substring(4,6) + "/" + expireTime.substring(6,8) + "/" + expireTime.substring(0,4) + " " + expireTime.substring(8,10) + expireTime.substring(10,12) + "z";

                //     var dateDiv1 = document.getElementById('dateDiv1');
                //     if (!dateDiv1.textContent) {
                //         dateDiv1.textContent = 'Day 1 Outlook Valid: ' + validFormatted + ' - ' + expireFormatted;
                //     }
                // }

                // Add a legend to the view
                var legend = new Legend({
                    view: view,
                    container: document.createElement("div"),
                    basemapLegendVisible: true,
                    respectLayerVisibility: false,
                    layerInfos: [
                        {
                            layer: stormreportsJson,
                            title: "Storm Report Icons"
                        },
                        {
                            layer: geojsonLayer,
                            title: "SPC Convective Outlook Categories"
                        },
                    ]
                });
                legend.container.classList.add("small-legend");

                // Wrap Legend in Expand widget
                var legendExpand = new Expand({
                    view: view,
                    content: legend,
                    expandIconClass: "esri-icon-legend", // Optional, defaults to "esri-icon-expand"
                    expandTooltip: "Legend"
                });

                // Add Expand widget to the view
                view.ui.add(legendExpand, "bottom-left");

                // Return the created layer
                return geojsonLayer;
            }

            // Get the current date and time (UTC, not local)
            var date = new Date();
            var year = date.getUTCFullYear();
            var month = ('0' + (date.getUTCMonth() + 1)).slice(-2);
            var day = ('0' + date.getUTCDate()).toString().slice(-2);
            var hour = date.getUTCHours().toString().padStart(2, '0');

            // Define the available hours for the day 1 convective outlook
            var availableHours = [1, 12, 13, 16.5, 20];

            // Determine the closest available hour to the current hour, for DAY 1
            var closestHour, result;
            if (hour < availableHours[0]) {
                // If the current hour is before the first available hour, use the last available hour from the previous day
                closestHour = availableHours[availableHours.length - 1];
                date.setDate(date.getDate() - 1);
                year = date.getUTCFullYear();
                month = ('0' + (date.getUTCMonth() + 1)).toString().slice(-2);
                day = (date.getUTCDate()).toString().slice(-2);
                result = { closestHour: closestHour, date: { year: year, month: month, day: day } };
            } else {
                // Otherwise, use the available hour that is closest to the current hour
                closestHour = availableHours.reduce(function(prev, curr) {
                    return (curr <= hour && Math.abs(curr - hour) < Math.abs(prev - hour) ? curr : prev);
                });
                result = { closestHour: closestHour, date: date };
            }

            // Get the data for the closest available hour
            var urlData = getUrl(closestHour, { year: year, month: month, day: day });
            console.log(urlData.url);

            // Fetch the data for the closest available hour
            fetch(urlData.url)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(function(data) {
                    // Ensure valid data is available
                    if (data.features && data.features[0] && data.features[0].properties && data.features[0].properties.VALID && data.features[0].properties.EXPIRE) {
                        // Extract the VALID and EXPIRE times
                        var validTime = data.features[0].properties.VALID;
                        var expireTime = data.features[0].properties.EXPIRE;

                        // Format the dates for display
                        var validFormatted = validTime.substring(4,6) + "/" + validTime.substring(6,8) + "/" + validTime.substring(0,4) + " " + validTime.substring(8,10) + validTime.substring(10,12) + "z";
                        var expireFormatted = expireTime.substring(4,6) + "/" + expireTime.substring(6,8) + "/" + expireTime.substring(0,4) + " " + expireTime.substring(8,10) + expireTime.substring(10,12) + "z";

                        // Update the dateDiv1 with the valid and expire times
                        var dateDiv1 = document.getElementById('dateDiv1');
                        dateDiv1.textContent = 'Day 1 Convective Outlook Valid: ' + validFormatted + ' - ' + expireFormatted;
                    } else {
                        console.error('Data does not have VALID and EXPIRE properties:', data);
                    }

                    // Now create the GeoJSON layer
                    var geojsonLayer = createGeoJSONLayer(urlData, data);

                    // Watch the visible property of the layer
                    geojsonLayer.watch("visible", function(visible) {
                        if (visible) {
                            updateDateDiv1(geojsonLayer);
                        }
                    });
                })
                .catch(function(error) {
                    console.error('Error fetching data:', error);
                });

            
                // Define the updateDateDiv function
            function updateDateDiv2(layer) {
                    console.log(urlDataDay2.url);
                    fetch(urlDataDay2.url)
                        .then(function(response) {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(function(data) {
                            // Check if the data has features and the first feature has VALID and EXPIRE properties
                            if (data.features && data.features[0] && data.features[0].properties && data.features[0].properties.VALID && data.features[0].properties.EXPIRE) {
                                // Update the date div
                                var validTime = data.features[0].properties.VALID;
                                var expireTime = data.features[0].properties.EXPIRE;

                                var validFormatted = validTime.substring(4,6) + "/" + validTime.substring(6,8) + "/" + validTime.substring(0,4) + " " + validTime.substring(8,10) + validTime.substring(10,12) + "z";
                                var expireFormatted = expireTime.substring(4,6) + "/" + expireTime.substring(6,8) + "/" + expireTime.substring(0,4) + " " + expireTime.substring(8,10) + expireTime.substring(10,12) + "z";

                                var dateDiv2 = document.getElementById('dateDiv1');
                                dateDiv2.textContent = 'Day 2 Convective Outlook Valid: ' + validFormatted + ' - ' + expireFormatted;
                            } else {
                                console.error('Data does not have VALID and EXPIRE properties:', data);
                            }
                        })
                        .catch(function(error) {
                            console.error('Error fetching data:', error);
                        });
                };


            // Define a function to create a GeoJSON layer for DAY 2
            function createGeoJSONLayer2(url, data) {
                // Remove any existing "Day 3 Convective Outlook" layer
                var existingLayer = map.findLayerById("Day2ConvectiveOutlook");
                if (existingLayer) {
                    map.remove(existingLayer);
                }

                // Define the severity order
                var severityOrder = ["High Risk", "Moderate Risk", "Enhanced Risk", "Slight Risk", "Marginal Risk", "General Thunderstorms Risk"];

                // Sort the features by severity
                data.features.sort((a, b) => severityOrder.indexOf(a.properties.LABEL2) - severityOrder.indexOf(b.properties.LABEL2));

                // Clip the polygons
                for (let i = 0; i < data.features.length; i++) {
                    for (let j = i + 1; j < data.features.length; j++) {
                        console.log(data.features);
                        console.log(data.features[i]);
                        console.log(data.features[j]);
                        if (data.features[i] && data.features[j]) {
                            try {
                                // Ensure both features are valid polygons
                                if (data.features[i].geometry.type === "Polygon" && data.features[j].geometry.type === "Polygon") {
                                    console.log(`Clipping feature ${j} with feature ${i}`);
                                    let difference = turf.difference(data.features[j], data.features[i]);
                                    if (difference) {
                                        data.features[j] = difference;
                                    } else {
                                        console.warn(`No difference found for feature ${j} with feature ${i}`);
                                    }
                                }
                            } catch (error) {
                                console.error('Error performing turf.difference:', error);
                            }
                        }
                    }
                }
                
                var renderer = {
                    type: "unique-value",
                    field: "LABEL2",
                    uniqueValueInfos: [
                        { 
                            "value": "General Thunderstorms Risk", 
                            "symbol": {
                                "type": "simple-fill", 
                                "color": [119, 186, 119, 0.35], 
                                "outline": { "width": 0.5, "color": "black" }
                            }
                        },
                        { 
                            "value": "Marginal Risk", 
                            "symbol": {
                                "type": "simple-fill", 
                                "color": [77, 255, 77, 0.3], 
                                "outline": { "width": 0.5, "color": "black" }
                            }
                        },
                        { 
                            "value": "Slight Risk", 
                            "symbol": {
                                "type": "simple-fill", 
                                "color": [255, 255, 0, 0.3], 
                                "outline": { "width": 0.5, "color": "black" }
                            }
                        },
                        { 
                            "value": "Enhanced Risk", 
                            "symbol": {
                                "type": "simple-fill", 
                                "color": [255, 153, 0, 0.35], 
                                "outline": { "width": 0.5, "color": "black" }
                            }
                        },
                        { 
                            "value": "Moderate Risk", 
                            "symbol": {
                                "type": "simple-fill", 
                                "color": [255, 0, 0, 0.4], 
                                "outline": { "width": 0.5, "color": "black" }
                            }
                        },
                        { 
                            "value": "High Risk", 
                            "symbol": {
                                "type": "simple-fill", 
                                "color": [199, 0, 199, 0.45], 
                                "outline": { "width": 0.5, "color": "black" }
                            }
                        }
                    ]
                };

                var geojsonLayer2 = new GeoJSONLayer({
                    url: url.url,
                    title: "Day 2 Convective Outlook",
                    id: "Day2ConvectiveOutlook", // Set the ID of the layer
                    visible: false,
                    renderer: renderer,
                    popupTemplate: {
                        title: "Day 2 Categorical Outlook",
                        content: "{LABEL2}"
                    }
                });

                // Add the GeoJSON layer to the map
                map.add(geojsonLayer2, 3);

                // Return the created layer
                return geojsonLayer2;


                // // Update the date div
                // if (data) {
                //     var validTime = data.features[0].properties.VALID;
                //     var expireTime = data.features[0].properties.EXPIRE;

                //     var validFormatted = validTime.substring(4,6) + "/" + validTime.substring(6,8) + "/" + validTime.substring(0,4) + " " + validTime.substring(8,10) + validTime.substring(10,12) + "z";
                //     var expireFormatted = expireTime.substring(4,6) + "/" + expireTime.substring(6,8) + "/" + expireTime.substring(0,4) + " " + expireTime.substring(8,10) + expireTime.substring(10,12) + "z";

                //     var dateDiv2 = document.getElementById('dateDiv');
                //     if (!dateDiv2.textContent) {
                //         dateDiv2.textContent = 'Day 2 Outlook Valid: ' + validFormatted + ' - ' + expireFormatted;
                //     }
                // }
            };
            
            // Define a function to get the URL for a given hour and date for Day 2
            function getUrlDay2(hour, date) {
                var minutes = Math.round((hour % 1) * 60);
                hour = ('0' + Math.floor(hour)).slice(-2);
                minutes = ('0' + minutes).slice(-2);
                var formattedDateTime = date.year + date.month + date.day + '_' + hour + minutes;
                var url = "https://apartment-optiplex.tail37d1f9.ts.net/proxy?url=https://www.spc.noaa.gov/products/outlook/archive/" + date.year + "/day2otlk_" + formattedDateTime + "_cat.lyr.geojson";
                return { url: url, formattedDateTime: formattedDateTime}
            };

            // Define a function to get the previous available hour
            function getPreviousHour2(hour, date) {
                var index = availableHours2.indexOf(hour);
                var year = date.getUTCFullYear();
                var month = ('0' + (date.getUTCMonth() + 1)).slice(-2);
                var day = ('0' + date.getUTCDate()).slice(-2);
                if (index > 0) {
                    return { hour: availableHours2[index - 1], date: { year: year, month: month, day: day } };
                } else if (index === 0 || index === -1) {
                    date.setDate(date.getDate() - 1);
                    var year = date.getUTCFullYear();
                    var month = ('0' + (date.getUTCMonth() + 1)).slice(-2);
                    var day = ('0' + date.getUTCDate()).slice(-2);
                    return { hour: availableHours2[availableHours2.length - 1], date: { year: year, month: month, day: day } };
                }
            };

            // Get the current date and time (UTC, not local)
            var date = new Date();
            var year = date.getUTCFullYear();
            var month = ('0' + (date.getUTCMonth() + 1)).slice(-2);
            var day = ('0' + date.getUTCDate()).toString().slice(-2);
            var hour = date.getUTCHours().toString().padStart(2, '0');

            // Define the available hours for the day 2 convective outlook
            var availableHours2 = [6, 17.5];

            // Determine the closest available hour to the current hour, for DAY 2
            var closestHour2, result2;
            if (hour < availableHours2[0]) {
                // If the current hour is before the first available hour, use the last available hour from the previous day
                closestHour2 = availableHours2[availableHours2.length - 1];
                date.setDate(date.getDate() - 1);
                year = date.getUTCFullYear();
                month = ('0' + (date.getUTCMonth() + 1)).toString().slice(-2);
                day = ('0' + date.getUTCDate()).toString().slice(-2);
                result2 = { closestHour2: closestHour2, date: { year: year, month: month, day: day } };
            } else {
                // Otherwise, use the available hour that is closest to the current hour
                closestHour2 = availableHours2.reduce(function(prev, curr) {
                    return (curr <= hour && Math.abs(curr - hour) < Math.abs(prev - hour) ? curr : prev);
                });
                result2 = { closestHour2: closestHour2, date: date };
            }

            // Get the data for the closest available hour for Day 2
            var urlDataDay2 = getUrlDay2(closestHour2, { year: year, month: month, day: day });
            console.log(urlDataDay2.url);

            // Fetch the data for the closest available hour for Day 2
            fetch(urlDataDay2.url)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(function(data) {
                    // Data for the new hour is available, proceed as normal
                    var geojsonLayer2 = createGeoJSONLayer2(urlDataDay2, data);

                    // Watch the visible property of the layer
                    geojsonLayer2.watch("visible", function(visible) {
                        if (visible) {
                            updateDateDiv2(geojsonLayer2);
                        }
                    });
                })
                .catch(function(error) {
                    if (error.message.startsWith("HTTP error")) {
                        // Handle HTTP errors here
                        console.log('HTTP error occurred:', error.message);
                        // Data for the new hour is not available, use the previous hour
                        var previous = getPreviousHour2(closestHour2, date);
                        url = getUrlDay2(previous.hour, previous.date);
                        fetch(url.url)
                            .then(function(response) {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.json();
                            })
                            .then(function(data) {
                                createGeoJSONLayer2(url, data);
                            })
                            .catch(function(error) {
                                console.error('Error fetching data:', error);
                            });
                    } else {
                        console.error('Some other error detected:', error);
                    }
                });
                
            
            // Define the updateDateDiv function
            function updateDateDiv3(layer) {
                    fetch(urlDataDay3.url)
                        .then(function(response) {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(function(data) {
                            // Check if the data has features and the first feature has VALID and EXPIRE properties
                            if (data.features && data.features[0] && data.features[0].properties && data.features[0].properties.VALID && data.features[0].properties.EXPIRE) {
                                // Update the date div
                                var validTime = data.features[0].properties.VALID;
                                var expireTime = data.features[0].properties.EXPIRE;

                                var validFormatted = validTime.substring(4,6) + "/" + validTime.substring(6,8) + "/" + validTime.substring(0,4) + " " + validTime.substring(8,10) + validTime.substring(10,12) + "z";
                                var expireFormatted = expireTime.substring(4,6) + "/" + expireTime.substring(6,8) + "/" + expireTime.substring(0,4) + " " + expireTime.substring(8,10) + expireTime.substring(10,12) + "z";

                                var dateDiv3 = document.getElementById('dateDiv1');
                                dateDiv3.textContent = 'Day 3 Convective Outlook Valid: ' + validFormatted + ' - ' + expireFormatted;
                            } else {
                                console.error('Data does not have VALID and EXPIRE properties:', data);
                            }
                        })
                        .catch(function(error) {
                            console.error('Error fetching data:', error);
                        });
                }


            // Define a function to create a GeoJSON layer for DAY 3
            function createGeoJSONLayer3(url, data) {
                // Remove any existing "Day 3 Convective Outlook" layer
                var existingLayer = map.findLayerById("Day3ConvectiveOutlook");
                if (existingLayer) {
                    map.remove(existingLayer);
                }
                var renderer = {
                    type: "unique-value",
                    field: "LABEL2",
                    uniqueValueInfos: [
                        { 
                            "value": "General Thunderstorms Risk", 
                            "symbol": {
                                "type": "simple-fill", 
                                "color": [119, 186, 119, 0.35], 
                                "outline": { "width": 0.5, "color": "black" }
                            }
                        },
                        { 
                            "value": "Marginal Risk", 
                            "symbol": {
                                "type": "simple-fill", 
                                "color": [77, 255, 77, 0.3], 
                                "outline": { "width": 0.5, "color": "black" }
                            }
                        },
                        { 
                            "value": "Slight Risk", 
                            "symbol": {
                                "type": "simple-fill", 
                                "color": [255, 255, 0, 0.3], 
                                "outline": { "width": 0.5, "color": "black" }
                            }
                        },
                        { 
                            "value": "Enhanced Risk", 
                            "symbol": {
                                "type": "simple-fill", 
                                "color": [255, 153, 0, 0.35], 
                                "outline": { "width": 0.5, "color": "black" }
                            }
                        },
                        { 
                            "value": "Moderate Risk", 
                            "symbol": {
                                "type": "simple-fill", 
                                "color": [255, 0, 0, 0.4], 
                                "outline": { "width": 0.5, "color": "black" }
                            }
                        },
                        { 
                            "value": "High Risk", 
                            "symbol": {
                                "type": "simple-fill", 
                                "color": [199, 0, 199, 0.45], 
                                "outline": { "width": 0.5, "color": "black" }
                            }
                        }
                    ]
                };

                var geojsonLayer3 = new GeoJSONLayer({
                    url: url.url,
                    title: "Day 3 Convective Outlook",
                    id: "Day3ConvectiveOutlook", // Set the ID of the layer
                    visible: false,
                    renderer: renderer,
                    popupTemplate: {
                        title: "Day 3 Categorical Outlook",
                        content: "{LABEL2}"
                    }
                });

                // Add the GeoJSON layer to the map
                map.add(geojsonLayer3, 2);

                return geojsonLayer3;


                // // Update the date div
                // if (data) {
                //     var validTime = data.features[0].properties.VALID;
                //     var expireTime = data.features[0].properties.EXPIRE;

                //     var validFormatted = validTime.substring(4,6) + "/" + validTime.substring(6,8) + "/" + validTime.substring(0,4) + " " + validTime.substring(8,10) + validTime.substring(10,12) + "z";
                //     var expireFormatted = expireTime.substring(4,6) + "/" + expireTime.substring(6,8) + "/" + expireTime.substring(0,4) + " " + expireTime.substring(8,10) + expireTime.substring(10,12) + "z";

                //     var dateDiv3 = document.getElementById('dateDiv');
                //     if (!dateDiv3.textContent) {
                //         dateDiv3.textContent = 'Day 3 Outlook Valid: ' + validFormatted + ' - ' + expireFormatted;
                //     }
                // }
            };

            

            // Define a function to get the URL for a given hour and date for Day 3
            function getUrlDay3(hour, date) {
                var minutes = Math.round((hour % 1) * 60);
                hour = ('0' + Math.floor(hour)).slice(-2);
                minutes = ('0' + minutes).slice(-2);
                var formattedDateTime = date.year + date.month + date.day + '_' + hour + minutes;
                var url = "https://apartment-optiplex.tail37d1f9.ts.net/proxy?url=https://www.spc.noaa.gov/products/outlook/archive/" + date.year + "/day3otlk_" + formattedDateTime + "_cat.lyr.geojson";
                return { url: url, formattedDateTime: formattedDateTime}
            }

            // Define a function to get the previous available hour
            function getPreviousHour3(hour, date) {
                var index = availableHours3.indexOf(hour);
                if (index > 0) {
                    return { hour: availableHours3[index - 1], date: date };
                } else if (index === 0 || index === -1) {
                    date.setDate(date.getDate() - 1);
                    var year = date.getUTCFullYear();
                    var month = ('0' + (date.getUTCMonth() + 1)).slice(-2);
                    var day = ('0' + date.getUTCDate()).slice(-2);
                    return { hour: availableHours3[availableHours3.length - 1], date: { year: year, month: month, day: day } };
                }
            }

            // Get the current date and time (UTC, not local)
            var date = new Date();
            var year = date.getUTCFullYear();
            var month = ('0' + (date.getUTCMonth() + 1)).slice(-2);
            var day = ('0' + date.getUTCDate()).toString().slice(-2);
            var hour = date.getUTCHours().toString().padStart(2, '0');

            // Define the available hours for the day 3 convective outlook
            var availableHours3 = [7.5, 19.5];

            // Determine the closest available hour to the current hour, for DAY 3
            var closestHour3, result3;
            if (hour < availableHours3[0]) {
                // If the current hour is before the first available hour, use the last available hour from the previous day
                closestHour3 = availableHours3[availableHours3.length - 1];
                date.setDate(date.getDate() - 1);
                year = date.getUTCFullYear();
                month = ('0' + (date.getUTCMonth() + 1)).toString().slice(-2);
                day = ('0' + date.getUTCDate()).toString().slice(-2);
                result3 = { closestHour3: closestHour3, date: { year: year, month: month, day: day } };
            } else {
                // Otherwise, use the available hour that is closest to the current hour
                closestHour3 = availableHours3.reduce(function(prev, curr) {
                    return (curr <= hour && Math.abs(curr - hour) < Math.abs(prev - hour) ? curr : prev);
                });
                result3 = { closestHour3: closestHour3, date: date };
            }

            // Get the data for the closest available hour for Day 3
            var urlDataDay3 = getUrlDay3(closestHour3, { year: year, month: month, day: day });
            console.log(urlDataDay3.url);

            // Fetch the data for the closest available hour for Day 3
            fetch(urlDataDay3.url)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(function(data) {
                    // Data for the new hour is available, proceed as normal
                    var geojsonLayer3 = createGeoJSONLayer3(urlDataDay3, data);

                    // Watch the visible property of the layer
                    geojsonLayer3.watch("visible", function(visible) {
                        if (visible) {
                            updateDateDiv3(geojsonLayer3);
                        }
                    });
                })
                .catch(function(error) {
                    if (error.message.startsWith("HTTP error")) {
                        // Handle HTTP errors here
                        console.log('HTTP error occurred:', error.message);
                        // Data for the new hour is not available, use the previous hour
                        var previous = getPreviousHour3(closestHour3, date);
                        url = getUrlDay3(previous.hour, previous.date);
                        fetch(url.url)
                            .then(function(response) {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.json();
                            })
                            .then(function(data) {
                                createGeoJSONLayer3(url, data);
                            })
                            .catch(function(error) {
                                console.error('Error fetching data:', error);
                            });
                    } else {
                        console.error('Some other error detected:', error);
                    }
                });


            // URL of the GeoJSON data
            var stormreportsJson = new GeoJSONLayer({
                url: "https://mesonet.agron.iastate.edu/data/gis/shape/4326/us/lsr_24hour.geojson",
                title: "Official Storm Reports",
                renderer: {
                    type: "unique-value",
                    field: "TYPETEXT",
                    uniqueValueInfos: [
                        {
                            value: "RAIN",
                            symbol: {
                                type: "picture-marker",
                                url: "rain.png",
                                width: "7.5px",
                                height: "9px"
                            }
                        },
                        {
                            value: "HAIL",
                            symbol: {
                                type: "picture-marker",
                                url: "hail.png",
                                width: "10px",
                                height: "10px"
                            }
                        },
                        {
                            value: "SNOW",
                            symbol: {
                                type: "picture-marker",
                                url: "snow.png",
                                width: "8px",
                                height: "8px"
                            }
                        },
                        {
                            value: "NON-TSTM WND GST",
                            symbol: {
                                type: "simple-marker",
                                style: "triangle",
                                color: [144, 238, 144, 1],
                                outline: {
                                    color: "black",
                                    width: 0.5
                                },
                                size: "7.5px"
                            }
                        },
                        {
                            value: "TSTM WND GST",
                            symbol: {
                                type: "simple-marker",
                                style: "triangle",
                                color: "yellow",
                                outline: {
                                    color: "black",
                                    width: 0.5
                                },
                                size: "7.5px"
                            }
                        },
                        {
                            value: "TSTM WND DMG",
                            symbol: {
                                type: "simple-marker",
                                style: "triangle",
                                color: "red",
                                outline: {
                                    color: "black",
                                    width: 0.5
                                },
                                size: "7.5px"
                            }
                        },
                        {
                            value: "HIGH SUST WINDS",
                            symbol: {
                                type: "simple-marker",
                                style: "triangle",
                                color: [255, 105, 180, 1],
                                outline: {
                                    color: "black",
                                    width: 0.5
                                },
                                size: "7.5px"
                            }
                        },
                        {
                            value: "TORNADO",
                            symbol: {
                                type: "picture-marker",
                                url: "tornado.png",
                                width: "15px",
                                height: "17.5px"
                            }
                        },
                        {
                            value: "FLOOD",
                            symbol: {
                                type: "picture-marker",
                                url: "flood.png",
                                width: "10px",
                                height: "10px"
                            }
                        },
                        {
                            value: "WILDFIRE",
                            symbol: {
                               type: "picture-marker",
                                url: "wildfire.png",
                                width: "12.5px",
                                height: "15px"
                            }
                        },
                        {
                            value: "OTHER",
                            symbol: {
                                type: "simple-marker",
                                style: "x",
                                color: "black",
                                size: "7.5px"
                            }
                        }
                    ]
                }
            });


            stormreportsJson.popupTemplate = {
                title: "{TYPETEXT}",
                content: [{
                    type: "fields",
                    fieldInfos: [
                        {
                            fieldName: "VALID",
                            label: "Valid",
                            visible: true
                        },
                        {
                            fieldName: "SOURCE",
                            label: "Source",
                            visible: true
                        },
                        {
                            fieldName: "REMARK",
                            label: "Remark",
                            visible: true
                        }
                    ]
                }]
            };

            map.add(stormreportsJson, 1);


            var userStormReports = new FeatureLayer({
                url: "https://services.arcgis.com/LBbVDC0hKPAnLRpO/arcgis/rest/services/User_Storm_Reports/FeatureServer",
                outFields: ["TYPETEXT", "REMARK", "VALID", "SOURCE"],
                id: "userStormReports",
                renderer: {
                    type: "unique-value",
                    field: "TYPETEXT",
                    uniqueValueInfos: [
                        {
                            value: "RAIN",
                            symbol: {
                                type: "picture-marker",
                                url: "rain.png",
                                width: "7.5px",
                                height: "9px"
                            }
                        },
                        {
                            value: "HAIL",
                            symbol: {
                                type: "picture-marker",
                                url: "hail.png",
                                width: "10px",
                                height: "10px"
                            }
                        },
                        {
                            value: "SNOW",
                            symbol: {
                                type: "picture-marker",
                                url: "snow.png",
                                width: "8px",
                                height: "8px"
                            }
                        },
                        {
                            value: "NON-TSTM WND GST",
                            symbol: {
                                type: "simple-marker",
                                style: "triangle",
                                color: [144, 238, 144, 1],
                                outline: {
                                    color: "black",
                                    width: 0.5
                                },
                                size: "7.5px"
                            }
                        },
                        {
                            value: "TSTM WND GST",
                            symbol: {
                                type: "simple-marker",
                                style: "triangle",
                                color: "yellow",
                                outline: {
                                    color: "black",
                                    width: 0.5
                                },
                                size: "7.5px"
                            }
                        },
                        {
                            value: "TSTM WND DMG",
                            symbol: {
                                type: "simple-marker",
                                style: "triangle",
                                color: "red",
                                outline: {
                                    color: "black",
                                    width: 0.5
                                },
                                size: "7.5px"
                            }
                        },
                        {
                            value: "HIGH SUST WINDS",
                            symbol: {
                                type: "simple-marker",
                                style: "triangle",
                                color: [255, 105, 180, 1],
                                outline: {
                                    color: "black",
                                    width: 0.5
                                },
                                size: "7.5px"
                            }
                        },
                        {
                            value: "TORNADO",
                            symbol: {
                                type: "picture-marker",
                                url: "tornado.png",
                                width: "15px",
                                height: "17.5px"
                            }
                        },
                        {
                            value: "FLOOD",
                            symbol: {
                                type: "picture-marker",
                                url: "flood.png",
                                width: "10px",
                                height: "10px"
                            }
                        },
                        {
                            value: "WILDFIRE",
                            symbol: {
                               type: "picture-marker",
                                url: "wildfire.png",
                                width: "12.5px",
                                height: "15px"
                            }
                        },
                        {
                            value: "OTHER",
                            symbol: {
                                type: "simple-marker",
                                style: "x",
                                color: "black",
                                size: "7.5px"
                            }
                        }
                    ]
                }
            });

            userStormReports.popupTemplate = {
                title: "{TYPETEXT}",
                content: [{
                    type: "fields",
                    fieldInfos: [
                        {
                            fieldName: "VALID",
                            label: "Valid",
                            visible: true
                        },
                        {
                            fieldName: "SOURCE",
                            label: "Source",
                            visible: true
                        },
                        {
                            fieldName: "REMARK",
                            label: "Remark",
                            visible: true
                        }
                    ]
                }]
            };

            map.add(userStormReports, 0);

            // Set up the Editor widget
            var editor = new Editor({
                view: view,
                visibleElements: { snappingControls: false },
                container: document.createElement("div"),
                layerInfos: [{
                    layer: userStormReports,
                    fieldConfig: [
                        {
                            name: "TYPETEXT",
                            label: "Type",
                            editorType: "field-selector",
                        
                        },
                        {
                            name: "REMARK",
                            label: "Remarks",
                            editorType: "text-box"
                        },
                        {
                            name: "VALID",
                            label: "Time",
                            editorType: "date-picker"
                        },
                        {
                            name: "SOURCE",
                            label: "Source",
                            editorType: "text-box"
                        }
                    ]
                }]
            });

            // Add Editor widget to the view
            editor.container.classList.add("editor-widget");

            // Wrap Editor in Expand widget
            var editorExpand = new Expand({
                    view: view,
                    content: editor,
                    expandIconClass: "esri-icon-plus", // Optional, defaults to "esri-icon-expand"
                    expandTooltip: "Editor"
                });

                // Add Expand widget to the view
                view.ui.add(editorExpand, "bottom-right");

            // Wrap LayerList in Expand widget
            var layerListExpand = new Expand({
                    view: view,
                    content: layerList,
                    expandIconClass: "esri-icon-layer-list", // Optional, defaults to "esri-icon-expand"
                    expandTooltip: "Layer List",
                    expanded: window.innerWidth > 786
                });

                // Add Expand widget to the view
                view.ui.add(layerListExpand, "top-right");

            // Assume layer1, layer2, layer3 are your GeoJSON layers for different days

            geojsonLayer.watch("visible", function(visible) {
                if (visible) {
                    updateDateDiv(geojsonLayer);
                }
            });

            geojsonLayer2.watch("visible", function(visible) {
                if (visible) {
                    updateDateDiv(geojsonLayer2);
                }
            });

            geojsonLayer3.watch("visible", function(visible) {
                if (visible) {
                    updateDateDiv(geojsonLayer3);
                }
            });

        }   

    );
    </script>

</body>

</html>
